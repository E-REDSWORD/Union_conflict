<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#14142a">
  <title>لعبة صراع النقابات - الإصدار الاستراتيجي</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ffbb33;
      --secondary: #6c5ce7;
      --dark: #1e1e2f;
      --darker: #14142a;
      --medium: #2c2c44;
      --light: #f7f7ff;
      --success: #00b894;
      --danger: #ff6b6b;
      --info: #54a0ff;
      --warning: #feca57;
      --card-bg: rgba(44, 44, 68, 0.85);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      direction: rtl;
      background: linear-gradient(135deg, var(--darker), var(--dark));
      background-attachment: fixed;
      color: var(--light);
      min-height: 100vh;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      line-height: 1.6;
    }
    
    .game-container {
      width: 100%;
      max-width: 100%;
      background: var(--card-bg);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.15);
      margin: 10px;
    }
    
    .header {
      background: linear-gradient(90deg, var(--darker), var(--dark));
      padding: 20px 15px;
      text-align: center;
      border-bottom: 3px solid var(--primary);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
      color: var(--primary);
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
      position: relative;
      display: inline-block;
      padding: 0 10px;
    }
    
    h1::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 25%;
      right: 25%;
      height: 3px;
      background: var(--secondary);
      border-radius: 3px;
    }
    
    h2 {
      font-size: 1.5rem;
      margin: 20px 0 15px;
      color: var(--warning);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary);
      position: relative;
    }
    
    h2::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 30%;
      right: 30%;
      height: 2px;
      background: var(--primary);
    }
    
    h3 {
      font-size: 1.2rem;
      margin: 15px 0 10px;
      color: var(--primary);
    }
    
    .content {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .section {
      background: rgba(35, 35, 55, 0.7);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
    }
    
    .flex-row {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .flex-col {
      width: 100%;
    }
    
    .guild-card {
      background: rgba(50, 50, 80, 0.9);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid var(--primary);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      transition: all 0.3s ease;
    }
    
    .guild-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }
    
    .guild-card h4 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--light);
      font-size: 1rem;
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(25, 25, 40, 0.8);
      color: var(--light);
      font-size: 1.05rem;
      transition: all 0.3s;
      height: 55px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(255, 187, 51, 0.4);
    }
    
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }
    
    button {
      padding: 16px 25px;
      border-radius: 12px;
      border: none;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
      min-height: 55px;
      user-select: none;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s;
    }
    
    button:hover::after {
      transform: translateX(0);
    }
    
    button i {
      font-size: 1.2rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #ffaa00);
      color: var(--darker);
    }
    
    .btn-primary:active {
      transform: translateY(3px);
      box-shadow: 0 3px 10px rgba(255, 187, 51, 0.5);
    }
    
    .btn-primary:disabled {
      background: linear-gradient(135deg, #666, #999);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), #5d4fe0);
      color: var(--light);
    }
    
    .btn-secondary:active {
      transform: translateY(3px);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #ff5252);
      color: var(--light);
    }
    
    .btn-danger:active {
      transform: translateY(3px);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #00a884);
      color: var(--light);
    }
    
    .btn-success:active {
      transform: translateY(3px);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #ff9f43);
      color: var(--darker);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: rgba(35, 35, 55, 0.6);
      border-radius: 12px;
      overflow: hidden;
      display: block;
      overflow-x: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    th {
      background: linear-gradient(to right, var(--darker), var(--secondary));
      padding: 15px;
      text-align: center;
      font-weight: 700;
      font-size: 1rem;
      white-space: nowrap;
    }
    
    td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 0.95rem;
      white-space: nowrap;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .action-select {
      min-width: 100%;
      background: rgba(30, 30, 50, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: var(--light);
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      height: 55px;
    }
    
    .target-select {
      min-width: 100%;
      background: rgba(50, 30, 40, 0.8);
      border: 2px solid var(--danger);
      color: var(--light);
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      height: 55px;
    }
    
    .round-summary {
      background: rgba(30, 30, 50, 0.9);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border-left: 5px solid var(--info);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .summary-title {
      color: var(--info);
      font-size: 1.2rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .summary-content {
      line-height: 1.7;
      font-size: 1rem;
    }
    
    .summary-content ul {
      padding-right: 20px;
    }
    
    .summary-content li {
      margin-bottom: 10px;
      padding-right: 10px;
      border-right: 3px solid var(--secondary);
    }
    
    .event-card {
      background: rgba(80, 50, 100, 0.8);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      border: 2px solid var(--secondary);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .event-title {
      color: var(--warning);
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }
    
    .points {
      font-weight: bold;
      font-size: 1.1rem;
      padding: 2px 8px;
      border-radius: 5px;
      display: inline-block;
    }
    
    .points.positive {
      background: rgba(0, 184, 148, 0.2);
      color: var(--success);
    }
    
    .points.negative {
      background: rgba(255, 107, 107, 0.2);
      color: var(--danger);
    }
    
    .winner-badge {
      background: var(--success);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-right: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(20, 20, 40, 0.7);
    }
    
    .hidden {
      display: none;
    }
    
    .guild-badge {
      display: inline-block;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      margin-left: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }
    
    .guild-1 { background: linear-gradient(135deg, #ff9a9e, #fad0c4); }
    .guild-2 { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); }
    .guild-3 { background: linear-gradient(135deg, #ffecd2, #fcb69f); }
    .guild-4 { background: linear-gradient(135deg, #84fab0, #8fd3f4); }
    .guild-5 { background: linear-gradient(135deg, #d4fc79, #96e6a1); }
    
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: rgba(30, 30, 50, 0.6);
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      background: rgba(40, 40, 60, 0.5);
    }
    
    .status-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .status-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .strategy-hint {
      background: rgba(80, 50, 100, 0.6);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      border-left: 4px solid var(--warning);
      font-size: 1rem;
    }
    
    .validation-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: -10px;
      margin-bottom: 10px;
      display: none;
      font-weight: 600;
    }
    
    .guilds-selector {
      background: rgba(50, 50, 80, 0.9);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid var(--info);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .start-btn-fixed {
      position: sticky;
      bottom: 20px;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }
    
    .timer-container {
      background: rgba(40, 40, 60, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      border: 2px solid var(--warning);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    #timer-display {
      font-size: 3.5rem;
      font-weight: bold;
      margin: 15px 0;
      color: var(--warning);
      font-family: monospace;
      text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
    }
    
    .timer-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .timer-controls button {
      width: 100%;
    }
    
    .display-view {
      background: rgba(20, 20, 40, 0.95);
      border-radius: 15px;
      padding: 25px;
      margin-top: 25px;
      border: 3px solid var(--info);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .guilds-display {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 25px 0;
      justify-content: center;
    }
    
    .guild-display-card {
      background: rgba(60, 60, 100, 0.9);
      border-radius: 12px;
      padding: 20px;
      min-width: 160px;
      text-align: center;
      border-left: 5px solid var(--primary);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s;
    }
    
    .guild-display-card:hover {
      transform: translateY(-5px);
    }
    
    .guild-display-name {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .guild-display-points {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      margin: 10px 0;
      text-shadow: 0 0 8px rgba(255, 187, 51, 0.4);
    }
    
    .announcement-bar {
      background: rgba(255, 187, 51, 0.25);
      border: 2px solid var(--warning);
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .stats-card {
      background: rgba(50, 50, 80, 0.9);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border-left: 5px solid var(--info);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-item {
      background: rgba(40, 40, 60, 0.7);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary);
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .save-load-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    .floating-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 200;
    }
    
    .floating-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      font-size: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .flex-row {
        flex-direction: row;
      }
      
      .flex-col {
        flex: 1;
        min-width: 300px;
      }
      
      .btn-group {
        flex-direction: row;
      }
      
      .timer-controls {
        flex-direction: row;
      }
      
      .actions {
        flex-direction: row;
      }
      
      .action-select, .target-select {
        min-width: 180px;
      }
      
      .save-load-container {
        flex-direction: row;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .guild-card, .section {
        padding: 15px;
      }
      
      button {
        padding: 14px 18px;
        font-size: 1rem;
      }
      
      .status-bar {
        flex-direction: column;
        gap: 12px;
      }
      
      .timer-controls button {
        width: 100%;
      }
      
      .guild-display-card {
        min-width: 130px;
        padding: 15px;
      }
      
      #timer-display {
        font-size: 2.8rem;
      }
    }
    
    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(30, 30, 50, 0.5);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
  </style>
</head>
<body>
  <div class="game-container fade-in">
    <div class="header">
    	<h1><i class="fa-solid fa-chess-queen"></i>𖤍 | 𝐑𝐄𝐃𝐒𝐖𝐎𝐑𝐃 & فريق التطوير</h2>
      <ul>
        <li><strong>𖤍 | 𝐑𝐄𝐃𝐒𝐖𝐎𝐑𝐃</strong> – قائد المشروع_برمجة</li></h1>
      <h2><i class="fa-solid fa-chess-queen"></i> لعبة صراع النقابات - الإصدار الاستراتيجي</h2>
      <p>إدارة المضيف - تحكم كامل في سير اللعبة وتطور الأحداث</p>
    </div>
    
    <div class="content">
      <!-- شاشة الإعداد -->
      <section id="setup-section" class="section">
        <h2><i class="fa-solid fa-cog"></i> إعداد النقابات واللاعبين</h2>
        <p>اختر عدد النقابات ثم أدخل أسماء النقابات وعدد اللاعبين في كل نقابة.</p>
        
        <div class="guilds-selector">
          <label>عدد النقابات:</label>
          <select id="guilds-count" class="guilds-count">
            <option value="">-- اختر عدد النقابات --</option>
            <option value="2">2 نقابات</option>
            <option value="3">3 نقابات</option>
            <option value="4">4 نقابات</option>
            <option value="5">5 نقابات</option>
          </select>
        </div>
        
        <div id="guilds-inputs" class="flex-col">
          <!-- سيتم إضافة حقول الإدخال هنا بشكل ديناميكي -->
        </div>
        
        <div class="btn-group">
          <button id="start-game-btn" class="btn-primary start-btn-fixed" disabled>
            <i class="fa-solid fa-play"></i> بدء اللعبة
          </button>
        </div>
        
        <div class="save-load-container">
          <button id="save-game-btn" class="btn-secondary">
            <i class="fa-solid fa-save"></i> حفظ اللعبة
          </button>
          <button id="load-game-btn" class="btn-info">
            <i class="fa-solid fa-folder-open"></i> استعادة اللعبة
          </button>
        </div>
      </section>
      
      <!-- شاشة اللعبة -->
      <section id="game-section" class="section hidden">
        <div class="flex-row">
          <div class="flex-col">
            <div class="status-bar">
              <div class="status-item">
                <div class="status-value" id="round-number">1</div>
                <div class="status-label">الجولة الحالية</div>
              </div>
              <div class="status-item">
                <div class="status-value" id="total-guilds">0</div>
                <div class="status-label">عدد النقابات</div>
              </div>
              <div class="status-item">
                <div class="status-value" id="total-players">0</div>
                <div class="status-label">عدد اللاعبين</div>
              </div>
            </div>
            
            <div class="guild-card">
              <h4><i class="fa-solid fa-lightbulb"></i> تعليمات الجولة</h4>
              <p>يجب على كل نقابة اختيار قرارها لهذه الجولة. بعد اختيار جميع القرارات، اضغط على "تأكيد القرارات" لحساب النتائج.</p>
              <div class="strategy-hint">
                <strong>نصائح استراتيجية:</strong> قراراتك تؤثر على النتائج بشكل ديناميكي بناءً على عدد اللاعبين، قرارات النقابات الأخرى، وعوامل عشوائية.
              </div>
            </div>
            
            <!-- نظام المؤقت -->
            <div class="timer-container">
              <h3><i class="fas fa-clock"></i> مؤقت الجولة</h3>
              <div id="timer-display">02:00</div>
              <div class="timer-controls">
                <button id="start-timer" class="btn-warning">
                  <i class="fas fa-play"></i> بدء المؤقت
                </button>
                <button id="pause-timer" class="btn-secondary">
                  <i class="fas fa-pause"></i> إيقاف
                </button>
                <button id="reset-timer" class="btn-danger">
                  <i class="fas fa-redo"></i> إعادة تعيين
                </button>
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>النقابة</th>
                    <th>اللاعبين</th>
                    <th>النقاط</th>
                    <th>القرار</th>
                    <th>الهدف (للأهــداف)</th>
                  </tr>
                </thead>
                <tbody id="guilds-table-body"></tbody>
              </table>
            </div>
            
            <div class="btn-group">
              <button id="submit-decisions-btn" class="btn-primary">
                <i class="fa-solid fa-calculator"></i> تأكيد القرارات وحساب النتائج
              </button>
              <button id="reset-game-btn" class="btn-danger">
                <i class="fa-solid fa-rotate-left"></i> إعادة تعيين اللعبة
              </button>
            </div>
          </div>
          
          <div class="flex-col">
            <h2>نتائج الجولة</h2>
            <div class="round-summary">
              <div class="summary-title">
                <i class="fa-solid fa-file-lines"></i>
                ملخص الجولة <span id="current-round">1</span>
              </div>
              <div class="summary-content" id="round-summary">
                <p>يرجى اختيار قرارات النقابات والضغط على "تأكيد القرارات" لرؤية نتائج الجولة.</p>
              </div>
              
              <div id="random-event" class="hidden">
                <div class="event-card">
                  <div class="event-title">
                    <i class="fa-solid fa-bolt"></i>
                    حدث مفاجئ!
                  </div>
                  <div id="event-description"></div>
                </div>
              </div>
            </div>
            
            <div class="btn-group">
              <button id="next-round-btn" class="btn-success hidden">
                <i class="fa-solid fa-forward"></i> جولة جديدة
              </button>
              <button id="filter-scores-btn" class="btn-secondary">
                <i class="fa-solid fa-filter"></i> تصفية النقاط السلبية
              </button>
            </div>
            
            <h3>نقاط النقابات</h3>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>النقابة</th>
                    <th>النقاط</th>
                    <th>التغيير</th>
                    <th>آخر قرار</th>
                  </tr>
                </thead>
                <tbody id="scores-table-body"></tbody>
              </table>
            </div>
            
            <!-- إحصائيات النقابات -->
            <div class="stats-card">
              <h3><i class="fa-solid fa-chart-line"></i> إحصائيات النقابات</h3>
              <div id="guild-stats" class="stats-grid">
                <!-- سيتم ملؤها ديناميكيًا -->
              </div>
            </div>
            
            <!-- شاشة العرض المبسطة للمشاركة -->
            <div id="display-view" class="display-view">
              <h2><i class="fas fa-share-alt"></i> عرض المشاركة</h2>
              <div class="announcement-bar" id="announcement">
                جاهز لعرض حالة اللعبة للمشاركين
              </div>
              <div class="display-content">
                <div class="round-info" style="font-size: 1.2rem; margin-bottom: 15px;">الجولة: <span id="display-round">1</span></div>
                <div id="guilds-display" class="guilds-display"></div>
                <div class="current-timer" style="font-size: 1.1rem; margin-top: 20px;">الوقت المتبقي: <span id="display-timer">02:00</span></div>
              </div>
              <button id="update-display" class="btn-secondary" style="margin-top: 20px;">
                <i class="fas fa-sync-alt"></i> تحديث العرض
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
    
    <div class="footer">
      <p>صممت بواسطة 𖤍|𝐑𝐄𝐃𝐒𝐖𝐎𝐑𝐃🇦🇷 | تم التطوير والتحسين <i class="fa-solid fa-heart"></i></p>
      <p>لعبة صراع النقابات - الإصدار 4.0 | جميع الحقوق محفوظة</p>
    </div>
  </div>

  <!-- عناصر التحكم العائمة -->
  <div class="floating-controls">
    <button id="save-float-btn" class="btn-secondary floating-btn">
      <i class="fa-solid fa-save"></i>
    </button>
    <button id="sound-toggle-btn" class="btn-warning floating-btn">
      <i class="fa-solid fa-volume-high"></i>
    </button>
  </div>

  <script>
    // بيانات اللعبة
    const decisions = [
      { value: "mission", label: "تنفيذ مهمة سرية", icon: "fa-solid fa-user-secret", color: "#54a0ff" },
      { value: "attack", label: "هجوم على نقابة أخرى", icon: "fa-solid fa-crosshairs", color: "#ff6b6b" },
      { value: "alliance", label: "تحالف", icon: "fa-solid fa-handshake", color: "#00b894" },
      { value: "bribe", label: "رشوة الحكم", icon: "fa-solid fa-money-bill-wave", color: "#feca57" },
      { value: "betray", label: "خيانة", icon: "fa-solid fa-mask", color: "#6c5ce7" },
      { value: "defend", label: "الدفاع", icon: "fa-solid fa-shield-alt", color: "#9b59b6" },
      { value: "diplomacy", label: "دبلوماسية", icon: "fa-solid fa-dove", color: "#1abc9c" }
    ];

    const randomEvents = [
      { 
        title: "هدية من الملك", 
        description: "الملك يمنح كل النقابات هبة مالية! كل نقابة تربح 2-5 نقاط.", 
        effect: guilds => guilds.forEach(g => {
          const bonus = Math.floor(Math.random() * 4) + 2;
          g.points += bonus;
          g.pointsChange += bonus;
        }),
        icon: "fa-solid fa-crown",
        color: "#feca57"
      },
      { 
        title: "كارثة طبيعية", 
        description: "زلزال مدمر يضرب المنطقة! كل النقابات تخسر 1-4 نقاط.", 
        effect: guilds => guilds.forEach(g => {
          const loss = Math.floor(Math.random() * 4) + 1;
          g.points -= loss;
          g.pointsChange -= loss;
        }),
        icon: "fa-solid fa-volcano",
        color: "#ff6b6b"
      },
      { 
        title: "اكتشاف منجم", 
        description: "اكتشاف منجم ذهب في أراضي إحدى النقابات! النقابة صاحبة أعلى نقاط تربح 5 نقاط.", 
        effect: guilds => {
          const topGuild = [...guilds].sort((a, b) => b.points - a.points)[0];
          topGuild.points += 5;
          topGuild.pointsChange += 5;
        },
        icon: "fa-solid fa-gem",
        color: "#feca57"
      },
      { 
        title: "وباء مفاجئ", 
        description: "وباء خطير يصيب المنطقة! النقابة صاحبة أقل نقاط تخسر 3 نقاط.", 
        effect: guilds => {
          const bottomGuild = [...guilds].sort((a, b) => a.points - b.points)[0];
          bottomGuild.points -= 3;
          bottomGuild.pointsChange -= 3;
        },
        icon: "fa-solid fa-virus",
        color: "#ff6b6b"
      }
    ];

    let guilds = [];
    let round = 1;
    let gameStarted = false;
    let filterNegative = false;
    let betrayers = {};
    let totalPlayers = 0;
    let timerInterval;
    let timeLeft = 120; // 2 دقيقة
    let soundEnabled = true;

    // عناصر واجهة المستخدم
    const guildsInputsDiv = document.getElementById('guilds-inputs');
    const setupSection = document.getElementById('setup-section');
    const gameSection = document.getElementById('game-section');
    const guildsTableBody = document.getElementById('guilds-table-body');
    const scoresTableBody = document.getElementById('scores-table-body');
    const roundNumberSpan = document.getElementById('round-number');
    const currentRoundSpan = document.getElementById('current-round');
    const roundSummaryDiv = document.getElementById('round-summary');
    const nextRoundBtn = document.getElementById('next-round-btn');
    const submitDecisionsBtn = document.getElementById('submit-decisions-btn');
    const resetGameBtn = document.getElementById('reset-game-btn');
    const startGameBtn = document.getElementById('start-game-btn');
    const filterScoresBtn = document.getElementById('filter-scores-btn');
    const randomEventDiv = document.getElementById('random-event');
    const eventDescriptionDiv = document.getElementById('event-description');
    const totalGuildsSpan = document.getElementById('total-guilds');
    const totalPlayersSpan = document.getElementById('total-players');
    const guildsCountSelect = document.getElementById('guilds-count');
    const saveGameBtn = document.getElementById('save-game-btn');
    const loadGameBtn = document.getElementById('load-game-btn');
    const saveFloatBtn = document.getElementById('save-float-btn');
    const soundToggleBtn = document.getElementById('sound-toggle-btn');
    
    // عناصر المؤقت
    const timerDisplay = document.getElementById('timer-display');
    const startTimerBtn = document.getElementById('start-timer');
    const pauseTimerBtn = document.getElementById('pause-timer');
    const resetTimerBtn = document.getElementById('reset-timer');
    
    // عناصر شاشة العرض
    const displayView = document.getElementById('display-view');
    const displayRound = document.getElementById('display-round');
    const displayTimer = document.getElementById('display-timer');
    const guildsDisplay = document.getElementById('guilds-display');
    const updateDisplayBtn = document.getElementById('update-display');
    const announcementBar = document.getElementById('announcement');
    const guildStatsDiv = document.getElementById('guild-stats');

    // إنشاء حقول الإدخال للنقابات بناءً على العدد المختار
    function createGuildInputs(count) {
      guildsInputsDiv.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'guild-card fade-in';
        div.innerHTML = `
          <h4>النقابة ${i + 1} <span class="guild-badge guild-${(i % 5) + 1}"></span></h4>
          <label>اسم النقابة:</label>
          <input type="text" class="guild-name" placeholder="أدخل اسم النقابة" required />
          <div class="validation-error" id="name-error-${i}">يرجى إدخال اسم النقابة</div>
          <label>عدد اللاعبين:</label>
          <input type="number" min="1" max="20" value="3" class="guild-players" required />
          <div class="validation-error" id="players-error-${i}">يرجى إدخال عدد صحيح بين 1 و 20</div>
        `;
        guildsInputsDiv.appendChild(div);

        const nameInput = div.querySelector('.guild-name');
        const playersInput = div.querySelector('.guild-players');
        const nameError = div.querySelector(`#name-error-${i}`);
        const playersError = div.querySelector(`#players-error-${i}`);
        
        nameInput.addEventListener('input', validateForm);
        playersInput.addEventListener('input', validateForm);
      }
      
      validateForm();
    }

    // التحقق من صحة النموذج
    function validateForm() {
      let isValid = true;
      const guildCards = guildsInputsDiv.querySelectorAll('.guild-card');
      
      if (guildCards.length === 0) {
        startGameBtn.disabled = true;
        return false;
      }
      
      guildCards.forEach((card, index) => {
        const nameInput = card.querySelector('.guild-name');
        const playersInput = card.querySelector('.guild-players');
        const nameError = card.querySelector(`#name-error-${index}`);
        const playersError = card.querySelector(`#players-error-${index}`);
        
        if (nameInput && nameInput.value.trim() === '') {
          if (nameError) nameError.style.display = 'block';
          isValid = false;
        } else {
          if (nameError) nameError.style.display = 'none';
        }
        
        if (playersInput) {
          const players = parseInt(playersInput.value);
          if (isNaN(players) || players < 1 || players > 20) {
            if (playersError) playersError.style.display = 'block';
            isValid = false;
          } else {
            if (playersError) playersError.style.display = 'none';
          }
        } else {
          isValid = false;
        }
      });
      
      startGameBtn.disabled = !isValid;
      return isValid;
    }

    // تحديث جدول النقابات
    function updateGuildsTable() {
      guildsTableBody.innerHTML = '';
      guilds.forEach((g, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'fade-in';
        tr.innerHTML = `
          <td>
            <span class="guild-badge guild-${(idx % 5) + 1}"></span>
            ${g.name}
          </td>
          <td>${g.players}</td>
          <td class="points">${g.points}</td>
          <td class="actions">
            <select class="action-select" id="decision-select-${idx}">
              <option value="">-- اختر القرار --</option>
              ${decisions.map(d => 
                `<option value="${d.value}" ${g.decision === d.value ? 'selected' : ''}>
                  ${d.label}
                </option>`
              ).join('')}
            </select>
          </td>
          <td class="actions">
            <select class="target-select" id="target-select-${idx}" ${g.decision === 'attack' || g.decision === 'alliance' ? '' : 'disabled'}>
              <option value="">-- اختر الهدف --</option>
              ${guilds.filter((_, i) => i !== idx).map(target => 
                `<option value="${target.name}" ${g.target === target.name ? 'selected' : ''}>
                  ${target.name}
                </option>`
              ).join('')}
            </select>
          </td>
        `;
        guildsTableBody.appendChild(tr);
        
        const decisionSelect = document.getElementById(`decision-select-${idx}`);
        const targetSelect = document.getElementById(`target-select-${idx}`);
        
        if(decisionSelect) {
          decisionSelect.addEventListener('change', function() {
            g.decision = this.value;
            if(targetSelect) {
              targetSelect.disabled = !(this.value === 'attack' || this.value === 'alliance');
              if (this.value !== 'attack' && this.value !== 'alliance') {
                g.target = null;
                targetSelect.value = '';
              }
            }
          });
        }
        
        if(targetSelect) {
          targetSelect.addEventListener('change', function() {
            g.target = this.value;
          });
        }
      });
    }

    // تحديث جدول النقاط
    function updateScoresTable() {
      scoresTableBody.innerHTML = '';
      
      const sortedGuilds = [...guilds].sort((a, b) => b.points - a.points);
      
      sortedGuilds.forEach((g, index) => {
        const guildIndex = guilds.findIndex(gg => gg.name === g.name);
        const tr = document.createElement('tr');
        tr.className = 'fade-in';
        
        let pointsChangeDisplay = '';
        if (g.pointsChange > 0) {
          pointsChangeDisplay = `<span class="points positive">+${g.pointsChange}</span>`;
        } else if (g.pointsChange < 0) {
          pointsChangeDisplay = `<span class="points negative">${g.pointsChange}</span>`;
        }
        
        let lastActionDisplay = '';
        if (g.lastAction) {
          const decision = decisions.find(d => d.value === g.lastAction);
          if (decision) {
            lastActionDisplay = `
              <i class="${decision.icon}" style="color: ${decision.color}"></i>
              ${decision.label}
            `;
          }
        }
        
        tr.innerHTML = `
          <td>
            <span class="guild-badge guild-${(guildIndex % 5) + 1}"></span>
            ${g.name}
            ${index === 0 && g.points > 0 ? '<span class="winner-badge">الرابح</span>' : ''}
          </td>
          <td class="points">${g.points}</td>
          <td>${pointsChangeDisplay}</td>
          <td>${lastActionDisplay}</td>
        `;
        scoresTableBody.appendChild(tr);
      });
    }

    // تحديث إحصائيات النقابات
    function updateGuildStats() {
      guildStatsDiv.innerHTML = '';
      
      guilds.forEach((guild, index) => {
        const statDiv = document.createElement('div');
        statDiv.className = 'stat-item fade-in';
        statDiv.innerHTML = `
          <div class="guild-display-name">
            <span class="guild-badge guild-${(index % 5) + 1}"></span>
            ${guild.name}
          </div>
          <div class="stat-value">${guild.points}</div>
          <div class="stat-label">النقاط الحالية</div>
          <div class="stat-value">${guild.players}</div>
          <div class="stat-label">عدد اللاعبين</div>
        `;
        guildStatsDiv.appendChild(statDiv);
      });
    }

    // بدء اللعبة
    function startGame() {
      if (!validateForm()) {
        announcement('يرجى تعبئة جميع بيانات النقابات بشكل صحيح');
        return;
      }
      
      guilds = [];
      const guildCards = guildsInputsDiv.querySelectorAll('.guild-card');
      
      totalPlayers = 0;
      
      guildCards.forEach((card, index) => {
        const nameInput = card.querySelector('.guild-name');
        const playersInput = card.querySelector('.guild-players');
        
        const name = nameInput.value.trim();
        const players = parseInt(playersInput.value) || 3;
        totalPlayers += players;
        
        guilds.push({ 
          name, 
          players, 
          points: 0, 
          decision: null, 
          target: null,
          lastAction: "",
          pointsChange: 0,
          betrayPenalty: false
        });
      });
      
      round = 1;
      roundNumberSpan.textContent = round;
      currentRoundSpan.textContent = round;
      displayRound.textContent = round;
      totalGuildsSpan.textContent = guilds.length;
      totalPlayersSpan.textContent = totalPlayers;
      setupSection.classList.add('hidden');
      gameSection.classList.remove('hidden');
      updateGuildsTable();
      updateScoresTable();
      updateGuildStats();
      roundSummaryDiv.innerHTML = "<p>يرجى اختيار قرارات النقابات والضغط على 'تأكيد القرارات'.</p>";
      nextRoundBtn.classList.add('hidden');
      submitDecisionsBtn.style.display = 'flex';
      randomEventDiv.classList.add('hidden');
      gameStarted = true;
      
      betrayers = {};
      resetTimer();
      saveGameState();
      
      // إعلان بدء اللعبة
      announcement("بدأت اللعبة! الجولة الأولى جاهزة.");
    }

    // نظام المؤقت
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      displayTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          announcement("انتهى وقت الجولة! الرجاء اتخاذ القرارات النهائية.");
          if (soundEnabled) playSound('end');
        }
      }, 1000);
      
      announcement("بدأ المؤقت! لديك دقيقتان لاتخاذ القرار.");
      if (soundEnabled) playSound('start');
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      announcement("تم إيقاف المؤقت مؤقتًا.");
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timeLeft = 120;
      updateTimerDisplay();
      announcement("تم إعادة تعيين المؤقت.");
    }

    // شاشة العرض المبسطة
    function updateDisplay() {
      displayRound.textContent = round;
      guildsDisplay.innerHTML = '';
      
      guilds.forEach((guild, index) => {
        const guildCard = document.createElement('div');
        guildCard.className = 'guild-display-card fade-in';
        guildCard.innerHTML = `
          <div class="guild-display-name">
            <span class="guild-badge guild-${(index % 5) + 1}"></span>
            ${guild.name}
          </div>
          <div class="guild-display-points">${guild.points}</div>
          <div>${guild.players} لاعبين</div>
        `;
        guildsDisplay.appendChild(guildCard);
      });
      
      announcement("تم تحديث شاشة العرض للمشاركين");
    }

    // نظام الإشعارات
    function announcement(message) {
      announcementBar.textContent = message;
      announcementBar.classList.remove('hidden');
      
      // إخفاء الإشعار بعد 5 ثوان
      setTimeout(() => {
        announcementBar.classList.add('hidden');
      }, 5000);
      
      // استخدام Web Speech API إذا كانت متوفرة والصوت مفعل
      if (soundEnabled && 'speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance();
        speech.text = message;
        speech.lang = 'ar-SA';
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        
        window.speechSynthesis.speak(speech);
      }
    }

    // تأثيرات صوتية (بدائل إذا لم تكن الملفات متوفرة)
    function playSound(soundType) {
      // هذه بدائل صوتية باستخدام نغمات بسيطة
      try {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(context.destination);
        
        switch(soundType) {
          case 'start':
            oscillator.frequency.setValueAtTime(523.25, context.currentTime); // C5
            break;
          case 'decision':
            oscillator.frequency.setValueAtTime(659.25, context.currentTime); // E5
            break;
          case 'result':
            oscillator.frequency.setValueAtTime(783.99, context.currentTime); // G5
            break;
          case 'event':
            oscillator.frequency.setValueAtTime(392.00, context.currentTime); // G4
            break;
          case 'end':
            oscillator.frequency.setValueAtTime(261.63, context.currentTime); // C4
            break;
        }
        
        gainNode.gain.setValueAtTime(0.3, context.currentTime);
        oscillator.start();
        
        setTimeout(() => {
          oscillator.stop();
        }, 500);
      } catch (e) {
        console.log("تعذر تشغيل الصوت:", e);
      }
    }

    // حساب نقاط القرار
    function calculateDecisionPoints(guild, decisionType) {
      const baseFactor = Math.floor(guild.players * 0.5);
      const roundFactor = Math.min(round * 0.2, 1.5);
      const randomFactor = 0.8 + Math.random() * 0.4;
      
      let basePoints = 0;
      
      switch(decisionType) {
        case 'mission': basePoints = 3 + Math.floor(Math.random() * 3); break;
        case 'attack': basePoints = 2 + Math.floor(Math.random() * 2); break;
        case 'alliance': basePoints = 1 + Math.floor(Math.random() * 2); break;
        case 'bribe': basePoints = 2 + Math.floor(Math.random() * 2); break;
        case 'betray': basePoints = 4 + Math.floor(Math.random() * 3); break;
        case 'defend': basePoints = 1 + Math.floor(Math.random() * 2); break;
        case 'diplomacy': basePoints = 1 + Math.floor(Math.random() * 3); break;
      }
      
      return Math.max(1, Math.floor(basePoints * baseFactor * roundFactor * randomFactor));
    }

    // حساب نتائج الجولة
    function calculateResults() {
      guilds.forEach((g, idx) => {
        const selectEl = document.getElementById(`decision-select-${idx}`);
        if (selectEl) {
          g.decision = selectEl.value;
          g.lastAction = g.decision;
          g.pointsChange = 0;
          
          if ((g.decision === 'attack' || g.decision === 'alliance') && !g.target) {
            const targetSelect = document.getElementById(`target-select-${idx}`);
            if (targetSelect && targetSelect.options.length > 1) {
              targetSelect.selectedIndex = 1;
              g.target = targetSelect.options[1].value;
            }
          }
        }
      });

      let allDecisionsValid = true;
      guilds.forEach(g => {
        if (!g.decision || ((g.decision === 'attack' || g.decision === 'alliance') && !g.target)) {
          allDecisionsValid = false;
        }
      });

      if (!allDecisionsValid) {
        announcement('يرجى اختيار قرارات صحيحة لجميع النقابات!\n- اختر قرارًا لكل نقابة\n- إذا اخترت "هجوم" أو "تحالف" يجب تحديد الهدف');
        return;
      }

      let summary = `<h3>نتائج الجولة ${round}:</h3><ul>`;
      
      guilds.forEach(g => {
        if (betrayers[g.name]) {
          const penalty = Math.floor(Math.random() * 3) + 2;
          g.points -= penalty;
          g.pointsChange -= penalty;
          summary += `<li>نقابة <strong>${g.name}</strong> خسرت <span class="points negative">${penalty} نقاط</span> بسبب عقوبة الخيانة السابقة.</li>`;
          betrayers[g.name] = false;
        }
      });

      guilds.forEach(g => {
        switch(g.decision) {
          case 'mission':
            const missionPoints = calculateDecisionPoints(g, 'mission');
            g.points += missionPoints;
            g.pointsChange += missionPoints;
            summary += `<li>نقابة <strong>${g.name}</strong> نفذت مهمة سرية وربحت <span class="points positive">${missionPoints} نقاط</span>.</li>`;
            break;
            
          case 'attack':
            const targetGuild = guilds.find(t => t.name === g.target);
            if (targetGuild) {
              const attackPoints = Math.max(1, Math.floor((2 + Math.floor(Math.random() * 3)) * (g.players / targetGuild.players) * (0.7 + Math.random() * 0.6)));
              targetGuild.points -= attackPoints;
              targetGuild.pointsChange -= attackPoints;
              g.points += Math.floor(attackPoints * 0.7);
              g.pointsChange += Math.floor(attackPoints * 0.7);
              summary += `<li>نقابة <strong>${g.name}</strong> هاجمت نقابة <strong>${g.target}</strong>، خصمتها <span class="points negative">${attackPoints} نقاط</span> وربحت <span class="points positive">${Math.floor(attackPoints * 0.7)} نقاط</span>.</li>`;
            }
            break;
            
          case 'alliance':
            const allianceGuild = guilds.find(t => t.name === g.target);
            if (allianceGuild) {
              const alliancePoints = calculateDecisionPoints(g, 'alliance');
              g.points += alliancePoints;
              g.pointsChange += alliancePoints;
              allianceGuild.points += Math.floor(alliancePoints * 0.8);
              allianceGuild.pointsChange += Math.floor(alliancePoints * 0.8);
              summary += `<li>نقابة <strong>${g.name}</strong> عقدت تحالفًا مع <strong>${g.target}</strong>، ربحت <span class="points positive">${alliancePoints} نقاط</span> وربحت النقابة المستهدفة <span class="points positive">${Math.floor(alliancePoints * 0.8)} نقاط</span>.</li>`;
            }
            break;
            
          case 'bribe':
            const bribePoints = calculateDecisionPoints(g, 'bribe');
            g.points += bribePoints;
            g.pointsChange += bribePoints;
            summary += `<li>نقابة <strong>${g.name}</strong> رشت الحكم وربحت <span class="points positive">${bribePoints} نقاط</span>.</li>`;
            break;
            
          case 'betray':
            const betrayPoints = calculateDecisionPoints(g, 'betray');
            g.points += betrayPoints;
            g.pointsChange += betrayPoints;
            betrayers[g.name] = true;
            summary += `<li>نقابة <strong>${g.name}</strong> خانت النقابات وربحت <span class="points positive">${betrayPoints} نقاط</span>، لكنها ستخسر نقاط في الجولة التالية.</li>`;
            break;
            
          case 'defend':
            const defensePoints = calculateDecisionPoints(g, 'defend');
            g.points += defensePoints;
            g.pointsChange += defensePoints;
            summary += `<li>نقابة <strong>${g.name}</strong> عززت دفاعاتها وربحت <span class="points positive">${defensePoints} نقاط</span>.</li>`;
            break;
            
          case 'diplomacy':
            const diplomacyPoints = calculateDecisionPoints(g, 'diplomacy');
            g.points += diplomacyPoints;
            g.pointsChange += diplomacyPoints;
            summary += `<li>نقابة <strong>${g.name}</strong> نفذت جهودًا دبلوماسية وربحت <span class="points positive">${diplomacyPoints} نقاط</span>.</li>`;
            break;
        }
      });

      guilds.forEach(g => {
        if (g.points < 0) g.points = 0;
      });

      summary += "</ul>";
      roundSummaryDiv.innerHTML = summary;

      // حدث عشوائي
      if (round > 1 && Math.random() > 0.4) {
        const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
        event.effect(guilds);
        
        randomEventDiv.classList.remove('hidden');
        eventDescriptionDiv.innerHTML = `
          <div class="event-title" style="color: ${event.color}">
            <i class="${event.icon}"></i>
            ${event.title}
          </div>
          <p>${event.description}</p>
        `;
        
        roundSummaryDiv.innerHTML += `
          <div class="event-card">
            <div class="event-title" style="color: ${event.color}">
              <i class="${event.icon}"></i>
              ${event.title}
            </div>
            <p>${event.description}</p>
          </div>
        `;
        
        announcement(`حدث مفاجئ: ${event.title}! ${event.description}`);
        if (soundEnabled) playSound('event');
      }

      updateScoresTable();
      updateGuildStats();
      updateDisplay();
      submitDecisionsBtn.style.display = 'none';
      nextRoundBtn.classList.remove('hidden');
      pauseTimer();
      saveGameState();
      
      announcement("تم حساب نتائج الجولة! الرجاء مراجعة النتائج.");
      if (soundEnabled) playSound('result');
    }

    // جولة جديدة
    function nextRound() {
      round++;
      roundNumberSpan.textContent = round;
      currentRoundSpan.textContent = round;
      displayRound.textContent = round;
      
      guilds.forEach(g => {
        g.decision = null;
        g.target = null;
        g.pointsChange = 0;
      });
      
      updateGuildsTable();
      roundSummaryDiv.innerHTML = "<p>يرجى اختيار قرارات النقابات والضغط على 'تأكيد القرارات'.</p>";
      nextRoundBtn.classList.add('hidden');
      submitDecisionsBtn.style.display = 'flex';
      randomEventDiv.classList.add('hidden');
      resetTimer();
      updateDisplay();
      saveGameState();
      
      announcement(`بدأت الجولة ${round}! لديكم دقيقتان لاتخاذ القرارات.`);
      if (soundEnabled) playSound('start');
    }

    // إعادة تعيين اللعبة
    function resetGame() {
      if(confirm("هل تريد حقًا إعادة تعيين اللعبة؟ سيتم مسح جميع النقاط والبيانات!")) {
        guilds = [];
        round = 1;
        betrayers = {};
        setupSection.classList.remove('hidden');
        gameSection.classList.add('hidden');
        roundSummaryDiv.innerHTML = '';
        guildsCountSelect.value = '';
        guildsInputsDiv.innerHTML = '';
        startGameBtn.disabled = true;
        clearInterval(timerInterval);
        localStorage.removeItem('guildConflictGame');
      }
    }

    // تصفية النقاط السلبية
    function filterNegativeScores() {
      filterNegative = !filterNegative;
      filterScoresBtn.innerHTML = filterNegative ? 
        '<i class="fa-solid fa-filter-circle-xmark"></i> إلغاء التصفية' : 
        '<i class="fa-solid fa-filter"></i> تصفية النقاط السلبية';
      
      guilds.forEach(g => {
        if (filterNegative && g.points < 0) {
          g.points = 0;
        }
      });
      
      updateScoresTable();
      updateGuildStats();
      updateDisplay();
      saveGameState();
    }

    // حفظ حالة اللعبة
    function saveGameState() {
      const gameState = {
        guilds,
        round,
        betrayers,
        totalPlayers,
        filterNegative,
        timeLeft
      };
      localStorage.setItem('guildConflictGame', JSON.stringify(gameState));
      announcement("تم حفظ حالة اللعبة بنجاح!");
    }

    // استعادة حالة اللعبة
    function loadGameState() {
      const savedGame = localStorage.getItem('guildConflictGame');
      if (savedGame) {
        const gameState = JSON.parse(savedGame);
        guilds = gameState.guilds;
        round = gameState.round;
        betrayers = gameState.betrayers;
        totalPlayers = gameState.totalPlayers;
        filterNegative = gameState.filterNegative;
        timeLeft = gameState.timeLeft || 120;
        
        roundNumberSpan.textContent = round;
        currentRoundSpan.textContent = round;
        displayRound.textContent = round;
        totalGuildsSpan.textContent = guilds.length;
        totalPlayersSpan.textContent = totalPlayers;
        setupSection.classList.add('hidden');
        gameSection.classList.remove('hidden');
        updateGuildsTable();
        updateScoresTable();
        updateGuildStats();
        updateDisplay();
        updateTimerDisplay();
        
        if (gameState.timeLeft > 0) {
          roundSummaryDiv.innerHTML = "<p>تم استعادة اللعبة. يمكنك متابعة من حيث توقفت.</p>";
        } else {
          roundSummaryDiv.innerHTML = "<p>يرجى اختيار قرارات النقابات والضغط على 'تأكيد القرارات'.</p>";
        }
        
        nextRoundBtn.classList.add('hidden');
        submitDecisionsBtn.style.display = 'flex';
        randomEventDiv.classList.add('hidden');
        gameStarted = true;
        
        announcement("تم استعادة اللعبة بنجاح!");
      } else {
        announcement("لا يوجد لعبة محفوظة!");
      }
    }

    // تبديل الصوت
    function toggleSound() {
      soundEnabled = !soundEnabled;
      soundToggleBtn.innerHTML = soundEnabled ? 
        '<i class="fa-solid fa-volume-high"></i>' : 
        '<i class="fa-solid fa-volume-xmark"></i>';
      announcement(soundEnabled ? "تم تفعيل الصوت" : "تم إيقاف الصوت");
    }

    // الأحداث
    startGameBtn.addEventListener('click', startGame);
    submitDecisionsBtn.addEventListener('click', calculateResults);
    nextRoundBtn.addEventListener('click', nextRound);
    resetGameBtn.addEventListener('click', resetGame);
    filterScoresBtn.addEventListener('click', filterNegativeScores);
    saveGameBtn.addEventListener('click', saveGameState);
    loadGameBtn.addEventListener('click', loadGameState);
    saveFloatBtn.addEventListener('click', saveGameState);
    soundToggleBtn.addEventListener('click', toggleSound);
    
    // أحداث المؤقت
    startTimerBtn.addEventListener('click', startTimer);
    pauseTimerBtn.addEventListener('click', pauseTimer);
    resetTimerBtn.addEventListener('click', resetTimer);
    updateDisplayBtn.addEventListener('click', updateDisplay);
    
    // حدث اختيار عدد النقابات
    guildsCountSelect.addEventListener('change', function() {
      const count = parseInt(this.value);
      if (count >= 2 && count <= 5) {
        createGuildInputs(count);
      }
    });

    // التحضير الأولي
    startGameBtn.disabled = true;
    updateTimerDisplay();
    
    // محاولة تحميل لعبة محفوظة
    window.addEventListener('load', () => {
      if (localStorage.getItem('guildConflictGame')) {
        if (confirm("يوجد لعبة محفوظة. هل ترغب في استعادتها؟")) {
          loadGameState();
        }
      }
    });
  </script>
</body>
</html>